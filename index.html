<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç’ç’çš„è‡ªä¹ å®¤</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,500;1,400&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // ç”Ÿæœºå‹ƒå‹ƒçš„ç»¿è‰²ç³»ä¸»è‰²è°ƒ
            primary: { DEFAULT: '#10B981', light: '#6EE7B7', dark: '#047857' }, // ç¿¡ç¿ ç»¿
            secondary: { DEFAULT: '#FBBF24', light: '#FDE68A' }, // æ¸©æš–é»„
            // èƒŒæ™¯è‰²è°ƒæ•´ï¼šç¨å¾®è°ƒæ·±ä¸€ç‚¹ç‚¹çš„è–„è·ç»¿ï¼Œè®©ç™½è‰²çš„é›ªèŠ±å’Œç§¯é›ªæ›´æ˜æ˜¾
            bg: { light: '#D1FAE5', dark: '#064E3B' }, 
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            serif: ['Lora', 'Georgia', 'serif'],
          },
          boxShadow: {
            'soft-xl': '0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02)',
          }
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      /* 3D ç›’å­ç›¸å…³æ ·å¼ (å¤ç”¨å¹¶ä¼˜åŒ–è‡ªæä¾›ä»£ç ) */
      .perspective { perspective: 1000px; }
      .preserve-3d { transform-style: preserve-3d; }
      .backface-hidden { backface-visibility: hidden; }
      
      .cube-scene { width: 200px; height: 200px; position: relative; }
      .cube {
        width: 100%; height: 100%; position: relative;
        transform-style: preserve-3d;
        transform: translateZ(-100px) rotateY(0deg) rotateX(10deg); /* åˆå§‹è½»å¾®å€¾æ–œæ›´æœ‰ç«‹ä½“æ„Ÿ */
        transition: transform 0.8s cubic-bezier(.2,.9,.2,1);
      }
      .cube.opened { transform: translateZ(-100px) rotateY(180deg) rotateX(0deg); }
      
      .face {
        position: absolute; width: 200px; height: 200px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 16px; backface-visibility: hidden;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        border: 2px solid rgba(255,255,255,0.2);
      }
      /* ç›’å­å…­é¢å®šä½ */
      .face.front  { transform: rotateY(0deg) translateZ(100px); background: linear-gradient(135deg, #6EE7B7, #10B981); }
      .face.back   { transform: rotateY(180deg) translateZ(100px); background: #ffffff; border: 4px solid #6EE7B7; color: #047857; flex-direction: column; padding: 20px; text-align: center;}
      .face.right  { transform: rotateY(90deg) translateZ(100px); background: #34D399; }
      .face.left   { transform: rotateY(-90deg) translateZ(100px); background: #34D399; }
      .face.bottom { transform: rotateX(-90deg) translateZ(100px); background: #059669; }

      /* ç›’ç›– Lid */
      .lid {
        position: absolute; width: 200px; height: 200px;
        top: 0; left: 0; background: linear-gradient(135deg, #6EE7B7, #34D399);
        transform-origin: top; transform: rotateX(90deg) translateY(-100px); /* åˆå§‹çŠ¶æ€æ˜¯ç›–ä½é¡¶éƒ¨çš„ */
        transition: transform 0.8s cubic-bezier(.2,.9,.2,1);
        border-radius: 16px; z-index: 20;
        border: 2px solid rgba(255,255,255,0.3);
        display: flex; align-items: center; justify-content: center; font-size: 3rem; color: white;
      }
      .lid.opened { transform: rotateX(210deg) translateY(-100px); /* æ‰“å¼€ç¿»è½¬ */ }

      /* è‡ªå®šä¹‰èƒŒæ™¯çº¹ç† */
      .bg-grid-pattern {
        background-color: theme('colors.bg.light');
        /* ç¨å¾®å¢åŠ ç½‘æ ¼çº¿çš„å¯è§åº¦ï¼Œå¢åŠ èƒŒæ™¯å±‚æ¬¡æ„Ÿ */
        background-image: linear-gradient(rgba(16, 185, 129, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(16, 185, 129, 0.1) 1px, transparent 1px);
        background-size: 20px 20px;
      }

      /* ä¸“æ³¨æ¨¡å¼ä¸‹çš„æ ·å¼è¦†ç›– */
      body.focus-mode {
        background-color: theme('colors.bg.dark'); /* å˜æš— */
        background-image: radial-gradient(circle at center, rgba(4, 120, 87, 0.4) 0%, rgba(6, 78, 59, 0.9) 100%); /* èšå…‰ç¯æ•ˆæœ */
        background-blend-mode: multiply;
      }
      
      body.focus-mode .main-card {
        @apply bg-opacity-10 backdrop-blur-lg border-opacity-20 text-white shadow-none;
        background-color: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
      }
      body.focus-mode .text-primary-dark { @apply text-green-100; }
      body.focus-mode .text-gray-600 { @apply text-green-200; }
      body.focus-mode .text-gray-800 { @apply text-white; }
      body.focus-mode .todo-item { @apply bg-white/10 text-white border-white/10; }
      
      /* å¼ºè°ƒè®¡æ—¶å™¨ */
      body.focus-mode .timer-display {
        text-shadow: 0 0 20px rgba(110, 231, 183, 0.5);
        @apply text-primary-light scale-105 transition-transform; /* å‡å°ç¼©æ”¾æ¯”ä¾‹é˜²æ­¢é®æŒ¡ */
      }
      
      /* å“åº”å¼å­—ä½“è°ƒæ•´ */
      .timer-display {
        font-variant-numeric: tabular-nums;
      }
      @media (max-width: 640px) {
        .timer-display { font-size: 3.5rem !important; }
      }
      
      /* éšè—éå¿…è¦å…ƒç´  */
      body.focus-mode .hide-on-focus {
        opacity: 0.3; pointer-events: none; filter: blur(2px); transition: all 0.5s;
      }

      /* èŠ‚æ—¥ç‰¹æ•ˆæ ·å¼ (åŸºç¡€) */
      .holiday-particle {
        position: fixed;
        top: -10vh;
        z-index: 9999;
        pointer-events: none;
        user-select: none;
        animation: fall linear forwards;
        will-change: transform;
      }

      /* é›ªèŠ±ç‰¹æœ‰æ ·å¼ (ä»…é™åœ£è¯) */
      .holiday-particle.snow {
        color: #cbd5e1; 
        text-shadow: 0 0 1px #64748b, 0 2px 4px rgba(0,0,0,0.1);
      }
      @keyframes fall {
        0% { transform: translateY(0) translateX(0) rotate(0deg); opacity: 1; }
        25% { transform: translateY(25vh) translateX(25px) rotate(45deg); }
        50% { transform: translateY(50vh) translateX(-25px) rotate(90deg); }
        75% { transform: translateY(75vh) translateX(25px) rotate(135deg); }
        100% { transform: translateY(110vh) translateX(0) rotate(180deg); opacity: 0; }
      }

      /* ç§¯é›ªå †ç§¯æ•ˆæœ - æ›´åŠ çœŸå®ä¸”å¯è§ */
      .snow-capped { position: relative !important; }
      
      .snow-capped::before, .snow-capped::after {
        content: ''; position: absolute;
        background: linear-gradient(180deg, #ffffff 0%, #e2e8f0 100%);
        border-bottom: 1px solid #94a3b8;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2), inset 0 2px 4px rgba(255,255,255,0.8);
        pointer-events: none;
      }
      
      .snow-capped::before {
        top: -12px; left: -2px; width: 65%; height: 22px;
        border-radius: 60% 40% 30% 20% / 100% 80% 40% 20%;
        z-index: 10;
      }
      
      .snow-capped::after {
        top: -10px; right: -2px; width: 55%; height: 20px;
        border-radius: 40% 60% 20% 30% / 80% 100% 20% 40%;
        z-index: 11;
      }
      /* é’ˆå¯¹æŒ‰é’®çš„å¾®è°ƒ */
      button.snow-capped::before { top: -8px; height: 14px; }
      button.snow-capped::after { top: -6px; height: 12px; }
      
      /* èŠ‚æ—¥è£…é¥°ç‰© */
      .holiday-decoration {
        position: fixed;
        bottom: 30px;
        right: 30px;
        font-size: 5rem;
        z-index: 40;
        filter: drop-shadow(0 8px 15px rgba(0,0,0,0.2));
        animation: bounce 2s infinite ease-in-out;
        cursor: pointer;
        transition: transform 0.3s;
      }
      .holiday-decoration:hover { transform: scale(1.2) rotate(10deg); }
      
      .holiday-decoration-left {
        position: fixed;
        bottom: 30px;
        left: 30px;
        font-size: 5rem;
        z-index: 40;
        filter: drop-shadow(0 8px 15px rgba(0,0,0,0.2));
        animation: swing 3s infinite ease-in-out;
        cursor: pointer;
        transition: transform 0.3s;
      }
      .holiday-decoration-left:hover { transform: scale(1.2) rotate(-10deg); }

      /* é¡¶éƒ¨æŒ‚é¥° */
      .holiday-garland {
        position: fixed;
        top: -10px;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: space-around;
        font-size: 3rem;
        z-index: 30;
        pointer-events: none;
        opacity: 0.9;
        filter: drop-shadow(0 5px 5px rgba(0,0,0,0.1));
      }
      .holiday-garland span {
        animation: swing 4s infinite ease-in-out;
        transform-origin: top center;
      }
      .holiday-garland span:nth-child(odd) { animation-duration: 3s; }
      .holiday-garland span:nth-child(even) { animation-duration: 5s; }

      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-15px); }
      }
      @keyframes swing {
        0%, 100% { transform: rotate(-5deg); }
        50% { transform: rotate(5deg); }
      }
    }
  </style>
</head>

<body class="bg-grid-pattern min-h-screen font-sans transition-all duration-700 ease-in-out overflow-x-hidden flex items-center justify-center p-4 sm:p-8">

  <main class="main-card max-w-5xl w-full mx-auto bg-white/80 backdrop-blur-xl rounded-[2rem] shadow-soft-xl p-6 sm:p-10 border border-white/40 transition-all duration-700 relative overflow-hidden">
    
    <div class="absolute -top-20 -right-20 w-64 h-64 bg-primary-light/20 rounded-full blur-3xl transition-opacity duration-700 hide-on-focus"></div>
    <div class="absolute -bottom-20 -left-20 w-80 h-80 bg-secondary-light/30 rounded-full blur-3xl transition-opacity duration-700 hide-on-focus"></div>

    <header class="text-center mb-10 relative z-10 hide-on-focus">
      <h1 class="text-3xl sm:text-4xl font-bold text-primary-dark font-serif mb-3">Today's studyğŸ“š</h1>
      <p class="text-gray-600 font-serif italic">â€œå®å®åŠ æ²¹å“‡ğŸ¥¹ğŸ¥¹ğŸ¥¹æœ€æ£’çš„ç’ç’â€</p>
    </header>

    <!-- çŠ¶æ€ä»ªè¡¨ç›˜ -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8 relative z-10 hide-on-focus">
      <div class="bg-white/60 backdrop-blur-sm p-4 rounded-2xl border border-white/50 shadow-sm flex flex-col items-center">
        <span class="text-gray-500 text-xs font-bold uppercase tracking-wider">ä»Šæ—¥ä¸“æ³¨</span>
        <span class="text-2xl font-bold text-primary-dark" id="todayTimeDisplay">0m</span>
      </div>
      <div class="bg-white/60 backdrop-blur-sm p-4 rounded-2xl border border-white/50 shadow-sm flex flex-col items-center">
        <span class="text-gray-500 text-xs font-bold uppercase tracking-wider">å½“å‰ç§¯åˆ†</span>
        <span class="text-2xl font-bold text-secondary" id="pointsDisplay">0</span>
      </div>
      <button onclick="openShop()" class="bg-white/60 hover:bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-white/50 shadow-sm flex flex-col items-center transition-all group cursor-pointer">
        <span class="text-gray-500 text-xs font-bold uppercase tracking-wider group-hover:text-primary">ç§¯åˆ†å•†åŸ</span>
        <i class="fa fa-gift text-2xl text-gray-400 group-hover:text-primary transition-colors mt-1"></i>
      </button>
      <button onclick="openCalendar()" class="bg-white/60 hover:bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-white/50 shadow-sm flex flex-col items-center transition-all group cursor-pointer">
        <span class="text-gray-500 text-xs font-bold uppercase tracking-wider group-hover:text-primary">æˆé•¿æ—¥å†</span>
        <i class="fa fa-calendar text-2xl text-gray-400 group-hover:text-primary transition-colors mt-1"></i>
      </button>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 relative z-10">
      
      <div class="lg:col-span-5 flex flex-col justify-center items-center p-6 rounded-3xl transition-all duration-500">
        
        <!-- è®¡æ—¶æ¨¡å¼åˆ‡æ¢ -->
        <div class="flex justify-center gap-2 mb-6 relative z-20 bg-gray-100/50 p-1 rounded-full backdrop-blur-sm hide-on-focus transition-all duration-500">
            <button onclick="switchTimerMode('up')" id="modeUpBtn" class="px-6 py-2 rounded-full text-sm font-bold transition-all shadow-sm bg-white text-primary">æ­£è®¡æ—¶</button>
            <button onclick="switchTimerMode('down')" id="modeDownBtn" class="px-6 py-2 rounded-full text-sm font-bold transition-all text-gray-500 hover:bg-white/50">å€’è®¡æ—¶</button>
        </div>

        <div class="timer-display text-6xl sm:text-8xl font-mono font-bold text-primary mb-4 tracking-wider transition-all duration-700">
          00:00:00
        </div>

        <!-- å€’è®¡æ—¶è®¾ç½®è¾“å…¥æ¡† -->
        <div id="countdownInputWrapper" class="hidden mb-6 flex items-center justify-center gap-3 hide-on-focus transition-all duration-500">
            <span class="text-gray-500 font-medium">ä¸“æ³¨æ—¶é•¿</span>
            <input type="number" id="countdownMinutes" value="25" min="1" max="180" onchange="updateCountdownDisplay()" class="w-20 text-center p-2 rounded-xl border-2 border-gray-200 focus:border-primary outline-none font-bold text-xl text-primary bg-white/80">
            <span class="text-gray-500 font-medium">åˆ†é’Ÿ</span>
        </div>
        
        <!-- è‡ªå®šä¹‰é¼“åŠ±è¯­è¾“å…¥ -->
        <div class="mb-8 w-full max-w-md relative group hide-on-focus transition-all duration-500">
             <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                <i class="fa fa-pencil text-gray-400"></i>
            </div>
            <input type="text" id="customQuoteInput" placeholder="âœ¨ åœ¨è¿™é‡Œå†™ä¸€å¥é¼“åŠ±è‡ªå·±çš„è¯..." class="w-full pl-10 pr-4 py-3 rounded-2xl border-2 border-white/50 bg-white/60 backdrop-blur-sm focus:border-primary focus:bg-white focus:ring-4 focus:ring-primary/10 outline-none transition-all text-gray-700 placeholder-gray-400 font-medium shadow-sm hover:shadow-md">
        </div>

        <div class="flex gap-4 scale-105">
          <button id="startBtn" onclick="startTimer()" class="group flex items-center gap-2 bg-primary hover:bg-primary-dark text-white px-8 py-3 rounded-full text-lg font-semibold transition-all shadow-md hover:shadow-lg active:scale-95">
            <i class="fa fa-play text-sm group-hover:animate-pulse"></i> å¼€å§‹ä¸“æ³¨
          </button>
          <button id="pauseBtn" onclick="pauseTimer()" class="hidden items-center gap-2 bg-secondary hover:bg-secondary-light hover:text-secondary-dark text-white px-8 py-3 rounded-full text-lg font-semibold transition-all shadow-md hover:shadow-lg active:scale-95">
            <i class="fa fa-pause text-sm"></i> æš‚åœ
          </button>
          <button id="resetBtn" onclick="stopTimerWithRewardCheck()" class="hidden group items-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-600 px-8 py-3 rounded-full text-lg font-semibold transition-all shadow-sm hover:shadow-md active:scale-95">
            <i class="fa fa-stop text-sm group-hover:rotate-90 transition-transform"></i> ç»“æŸ
          </button>
        </div>
        <p id="timerStatus" class="mt-6 text-gray-500 text-sm font-medium opacity-0 transition-opacity">å‡†å¤‡è¿›å…¥å¿ƒæµçŠ¶æ€...</p>
        
        <!-- ä¸“æ³¨æ¨¡å¼ä¸‹çš„é¼“åŠ±è¯­è½®æ’­ -->
        <div id="focusQuotes" class="hidden mt-12 text-center max-w-2xl h-24 flex items-center justify-center px-4">
            <p class="text-xl sm:text-2xl font-sans font-semibold text-white tracking-wide transition-opacity duration-500" id="quoteText" style="text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                ä¿æŒä¸“æ³¨ï¼Œä½ å°±æ˜¯æœ€æ£’çš„ï¼
            </p>
        </div>
      </div>

      <div class="lg:col-span-7 bg-white/50 rounded-3xl p-6 sm:p-8 border border-gray-100 shadow-sm transition-all duration-500">
        <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
          <span class="mr-2 text-2xl">ğŸ“</span> ä»Šæ—¥è®¡åˆ’æ¸…å•
        </h3>
        
        <form id="todoForm" class="flex gap-3 mb-6" action="javascript:void(0);">
          <input type="text" id="todoInput" placeholder="å†™ä¸‹æ¥ä¸‹æ¥çš„å°ç›®æ ‡..." class="flex-1 p-4 rounded-xl border-2 border-gray-100 focus:border-primary/50 focus:ring-4 focus:ring-primary/10 outline-none transition-all bg-white/80 backdrop-blur-sm font-medium text-gray-700 placeholder-gray-400">
          <button type="submit" class="bg-primary hover:bg-primary-dark text-white p-4 rounded-xl transition-colors shadow-md active:scale-95">
            <i class="fa fa-plus text-lg"></i>
          </button>
        </form>

        <ul id="todoList" class="space-y-3 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
          </ul>
      </div>
    </div>
  </main>

  <div id="rewardModal" class="fixed inset-0 z-50 flex items-center justify-center pointer-events-none opacity-0 transition-all duration-500">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
    
    <div class="relative z-10 flex flex-col items-center scale-90 transition-all duration-500" id="modalContent">
      <h2 class="text-white text-3xl font-bold mb-8 font-serif text-shadow-lg">ğŸ‰ ä¸“æ³¨å®Œæˆï¼ä½ çš„å¥–åŠ±å·²é€è¾¾</h2>
      
      <div class="perspective cube-scene cursor-pointer" onclick="openRewardBox()">
        <div class="cube" id="rewardCube">
          <div class="face front flex flex-col text-white">
            <span class="text-5xl mb-2">ğŸ</span>
            <span class="font-bold text-lg">ç‚¹æˆ‘æ‹†å¼€</span>
          </div>
          <div class="face back">
            <div class="text-5xl mb-4" id="rewardIcon">ğŸ’–</div>
            <p class="text-lg font-serif text-primary-dark font-bold mb-2" id="rewardTitle">ç‰¹åˆ«é¼“åŠ±</p>
            <p class="text-gray-600 font-medium italic px-4" id="rewardMessage">åŠ è½½ä¸­...</p>
          </div>
          <div class="face right"></div>
          <div class="face left"></div>
          <div class="face bottom"></div>
          <div class="lid" id="rewardLid">âœ¨</div>
        </div>
      </div>

      <button onclick="closeRewardModal()" class="mt-10 bg-white text-primary-dark px-8 py-3 rounded-full font-bold shadow-lg hover:bg-gray-100 hover:scale-105 transition-all active:scale-95">
        æ”¶ä¸‹èƒ½é‡ï¼Œç»§ç»­å‰è¡Œ
      </button>
    </div>
  </div>

  <!-- ç§¯åˆ†å•†åŸæ¨¡æ€æ¡† -->
  <div id="shopModal" class="fixed inset-0 z-50 flex items-center justify-center pointer-events-none opacity-0 transition-all duration-300">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeShop()"></div>
    <div class="relative z-10 bg-white w-full max-w-2xl mx-4 rounded-3xl shadow-2xl p-6 sm:p-8 scale-95 transition-all duration-300 max-h-[85vh] overflow-y-auto custom-scrollbar" id="shopContent">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i class="fa fa-gift text-secondary"></i> ç§¯åˆ†å•†åŸ</h2>
        <button onclick="closeShop()" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors"><i class="fa fa-times"></i></button>
      </div>
      
      <div class="bg-secondary-light/20 p-4 rounded-xl mb-6 flex justify-between items-center">
        <span class="text-gray-700 font-medium">å½“å‰å¯ç”¨ç§¯åˆ†</span>
        <span class="text-2xl font-bold text-secondary-dark" id="shopPointsDisplay">0</span>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-3 gap-4" id="shopItems">
        <!-- å•†å“åˆ—è¡¨å°†é€šè¿‡ JS ç”Ÿæˆ -->
      </div>
    </div>
  </div>

  <!-- æˆé•¿æ—¥å†æ¨¡æ€æ¡† -->
  <div id="calendarModal" class="fixed inset-0 z-50 flex items-center justify-center pointer-events-none opacity-0 transition-all duration-300">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeCalendar()"></div>
    <div class="relative z-10 bg-white w-full max-w-4xl mx-4 rounded-3xl shadow-2xl p-6 sm:p-8 scale-95 transition-all duration-300 max-h-[90vh] overflow-y-auto custom-scrollbar" id="calendarContent">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2"><i class="fa fa-calendar text-primary"></i> æˆé•¿æ—¥å†</h2>
        <button onclick="closeCalendar()" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors"><i class="fa fa-times"></i></button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- å·¦ä¾§æ—¥å†ç½‘æ ¼ -->
        <div class="lg:col-span-2">
          <div class="flex justify-between items-center mb-4">
            <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full"><i class="fa fa-chevron-left text-gray-500"></i></button>
            <h3 class="text-lg font-bold text-gray-800" id="calendarMonthYear">2023å¹´ 10æœˆ</h3>
            <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full"><i class="fa fa-chevron-right text-gray-500"></i></button>
          </div>
          <div class="grid grid-cols-7 gap-2 text-center mb-2">
            <div class="text-gray-400 text-sm py-2">æ—¥</div>
            <div class="text-gray-400 text-sm py-2">ä¸€</div>
            <div class="text-gray-400 text-sm py-2">äºŒ</div>
            <div class="text-gray-400 text-sm py-2">ä¸‰</div>
            <div class="text-gray-400 text-sm py-2">å››</div>
            <div class="text-gray-400 text-sm py-2">äº”</div>
            <div class="text-gray-400 text-sm py-2">å…­</div>
          </div>
          <div class="grid grid-cols-7 gap-2" id="calendarGrid">
            <!-- æ—¥å†æ ¼å­ JS ç”Ÿæˆ -->
          </div>
        </div>

        <!-- å³ä¾§æ—¥è®°ç¼–è¾‘åŒº -->
        <div class="bg-gray-50 rounded-2xl p-6 border border-gray-100">
          <div class="text-center mb-4">
            <span class="text-sm text-gray-500 uppercase tracking-wider">Selected Date</span>
            <h3 class="text-xl font-bold text-primary-dark mt-1" id="selectedDateDisplay">--</h3>
          </div>
          
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">ä»Šæ—¥çŠ¶æ€</label>
            <div class="flex justify-between bg-white p-2 rounded-xl border border-gray-200" id="moodSelector">
              <button onclick="selectMood('happy')" class="mood-btn p-2 rounded-lg hover:bg-yellow-50 transition-colors text-2xl" data-mood="happy">ğŸ˜„</button>
              <button onclick="selectMood('calm')" class="mood-btn p-2 rounded-lg hover:bg-green-50 transition-colors text-2xl" data-mood="calm">ğŸ˜Œ</button>
              <button onclick="selectMood('tired')" class="mood-btn p-2 rounded-lg hover:bg-blue-50 transition-colors text-2xl" data-mood="tired">ğŸ˜«</button>
              <button onclick="selectMood('sad')" class="mood-btn p-2 rounded-lg hover:bg-gray-100 transition-colors text-2xl" data-mood="sad">ğŸ˜¢</button>
              <button onclick="selectMood('fire')" class="mood-btn p-2 rounded-lg hover:bg-red-50 transition-colors text-2xl" data-mood="fire">ğŸ”¥</button>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">å†™ç»™è‡ªå·±çš„è¯</label>
            <textarea id="dailyNote" rows="6" class="w-full p-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none resize-none text-sm bg-white" placeholder="è®°å½•ä»Šå¤©çš„å°ç¡®å¹¸..."></textarea>
          </div>

          <button onclick="saveDailyLog()" class="w-full bg-primary hover:bg-primary-dark text-white py-3 rounded-xl font-bold shadow-md transition-all active:scale-95">ä¿å­˜è®°å½•</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===========================
    // å…¨å±€å˜é‡ä¸é…ç½®
    // ===========================
    let startTime;
    let elapsedTime = 0;
    let timerInterval;
    let isStudying = false;
    // è®¾ç½®ä¸€ä¸ªè·å¾—å¥–åŠ±çš„æœ€çŸ­ä¸“æ³¨æ—¶é—´ (ä¾‹å¦‚ 1åˆ†é’Ÿï¼Œæ–¹ä¾¿æµ‹è¯•ï¼Œå®é™…ä½¿ç”¨å¯è®¾ä¸º 15 * 60 * 1000)
    const MIN_FOCUS_TIME_FOR_REWARD = 10 * 1000; 

    // é¼“åŠ±è¯­æ–™åº“ (ç”Ÿæœºã€æ¸…æ–°ã€æ­£å‘)
    const rewardMessages = [
        { icon: 'ğŸŒ±', title: 'ç ´åœŸè€Œå‡º', msg: 'æ¯ä¸€æ¬¡ä¸“æ³¨ï¼Œéƒ½æ˜¯åœ¨æ‰æ ¹ã€‚ä½ æ­£åœ¨ç§¯è“„å‘ä¸Šçš„åŠ›é‡ï¼' },
        { icon: 'â˜€ï¸', title: 'è¿½å…‰è€…', msg: 'ä½ åŠªåŠ›çš„æ ·å­ï¼Œå°±åƒæ”¶é›†é˜³å…‰çš„è¿‡ç¨‹ï¼Œè¶…çº§è€€çœ¼ã€‚' },
        { icon: 'ğŸ’§', title: 'æ¶¦ç‰©æ— å£°', msg: 'çŸ¥è¯†åƒéœ²æ°´ä¸€æ ·æ»‹æ¶¦ç€ä½ ï¼Œä»Šå¤©åˆå˜å‰å®³äº†ä¸€ç‚¹ç‚¹å‘¢ã€‚' },
        { icon: 'ğŸƒ', title: 'è‡ªåœ¨ç”Ÿé•¿', msg: 'æŒ‰ç…§è‡ªå·±çš„èŠ‚å¥æ¥ï¼Œä¸ç”¨ç„¦è™‘ï¼Œä½ æ­£åœ¨ç¨³æ­¥å‰è¡Œã€‚' },
        { icon: 'ğŸ¦‹', title: 'ç ´èŒ§æˆè¶', msg: 'ç°åœ¨çš„æ²‰æ·€ï¼Œæ˜¯ä¸ºäº†å°†æ¥æ›´ç¾çš„ç»½æ”¾ã€‚è¾›è‹¦å•¦ï¼' },
        { icon: 'ğŸŠ', title: 'å…ƒæ°”è¡¥ç»™', msg: 'å¿«å»å–å£æ°´ï¼Œä¼¸ä¸ªæ‡’è…°ï¼Œä¼‘æ¯ä¸€ä¸‹ä¹Ÿæ˜¯ä¸ºäº†æ›´å¥½çš„å‡ºå‘~' },
        { icon: 'âœ¨', title: 'é—ªé—ªå‘å…‰', msg: 'è¶…çº§æ£’ï¼åˆšæ‰ä¸“æ³¨çš„ä½ ï¼Œæ•´ä¸ªäººéƒ½åœ¨å‘å…‰è¯¶ï¼' }
    ];

    // ä¸“æ³¨æ¨¡å¼è½®æ’­è¯­å½• (æ›´é€‚åˆå¤§å­¦ç”Ÿçš„å“²ç†ä¸åŠ¨åŠ›)
    const focusQuotes = [
        "åšå­¦ä¹‹ï¼Œå®¡é—®ä¹‹ï¼Œæ…æ€ä¹‹ï¼Œæ˜è¾¨ä¹‹ï¼Œç¬ƒè¡Œä¹‹ã€‚",
        "æœªç»å®¡è§†çš„äººç”Ÿæ˜¯ä¸å€¼å¾—è¿‡çš„ã€‚",
        "ç§ä¸€æ£µæ ‘æœ€å¥½çš„æ—¶é—´æ˜¯åå¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨ã€‚",
        "æµæ°´ä¸äº‰å…ˆï¼Œäº‰çš„æ˜¯æ»”æ»”ä¸ç»ã€‚",
        "ä½ çš„èŒè´£æ˜¯å¹³æ•´åœŸåœ°ï¼Œè€Œéç„¦è™‘æ—¶å…‰ã€‚åœ¨ä¸‰å››æœˆåšçš„äº‹ï¼Œå…«ä¹æœˆè‡ªæœ‰ç­”æ¡ˆã€‚",
        "Stay hungry, stay foolish.",
        "å‡¡æ˜¯è¿‡å¾€ï¼Œçš†ä¸ºåºç« ã€‚",
        "æˆ‘ä»¬ç»ˆæ­¤ä¸€ç”Ÿï¼Œå°±æ˜¯è¦æ‘†è„±ä»–äººçš„æœŸå¾…ï¼Œæ‰¾åˆ°çœŸæ­£çš„è‡ªå·±ã€‚",
        "Education is the kindling of a flame, not the filling of a vessel.",
        "çŸ¥ä¹‹è€…ä¸å¦‚å¥½ä¹‹è€…ï¼Œå¥½ä¹‹è€…ä¸å¦‚ä¹ä¹‹è€…ã€‚",
        "æ˜Ÿå…‰ä¸é—®èµ¶è·¯äººï¼Œæ—¶å…‰ä¸è´Ÿæœ‰å¿ƒäººã€‚"
    ];

    // ä¸“æ³¨æ¨¡å¼è½®æ’­è¯­å½• (å·²å¼ƒç”¨)
    const unusedQuotes = [
        "ä¹¾å¤æœªå®šï¼Œä½ æˆ‘çš†æ˜¯é»‘é©¬ ğŸ",
        "å°†æ¥çš„ä½ ï¼Œä¸€å®šä¼šæ„Ÿè°¢ç°åœ¨æ‹¼å‘½çš„è‡ªå·± ï¿½",
        "ä¸è¦å‡è£…åŠªåŠ›ï¼Œç»“æœä¸ä¼šé™ªä½ æ¼”æˆ ğŸš«",
        "æˆåŠŸçš„è·¯ä¸Šå¹¶ä¸æ‹¥æŒ¤ï¼Œå› ä¸ºåšæŒçš„äººä¸å¤š ï¿½ï¸",
        "è€å¾—ä½å¯‚å¯ï¼Œæ‰å®ˆå¾—ä½ç¹å ğŸŒº",
        "ä½ çš„æ½œåŠ›è¿œè¶…ä½ çš„æƒ³è±¡ ğŸš€",
        "æ—¢ç„¶é€‰æ‹©äº†è¿œæ–¹ï¼Œä¾¿åªé¡¾é£é›¨å…¼ç¨‹ ğŸŒˆ",
        "è‡ªå¾‹å³è‡ªç”± ğŸ•Šï¸",
        "Focus on the goal, not the obstacle. ï¿½",
        "æ˜Ÿå…‰ä¸é—®èµ¶è·¯äººï¼Œæ—¶å…‰ä¸è´Ÿæœ‰å¿ƒäºº ğŸŒŸ"
    ];
    let quoteInterval;

    function startQuoteCarousel() {
        const quoteContainer = document.getElementById('focusQuotes');
        const quoteText = document.getElementById('quoteText');
        quoteContainer.classList.remove('hidden');
        
        const customQuote = localStorage.getItem('timer_custom_quote');

        if (customQuote) {
            quoteText.textContent = customQuote;
            quoteText.style.opacity = 1;
            if (quoteInterval) clearInterval(quoteInterval);
        } else {
            // ç«‹å³æ˜¾ç¤ºç¬¬ä¸€æ¡
            quoteText.textContent = focusQuotes[Math.floor(Math.random() * focusQuotes.length)];
            quoteText.style.opacity = 1;
            
            quoteInterval = setInterval(() => {
                // æ·¡å‡º
                quoteText.style.opacity = 0;
                setTimeout(() => {
                    // åˆ‡æ¢æ–‡å­—å¹¶æ·¡å…¥
                    quoteText.textContent = focusQuotes[Math.floor(Math.random() * focusQuotes.length)];
                    quoteText.style.opacity = 1;
                }, 500); // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»å®Œæˆ
            }, 5000); // æ¯5ç§’åˆ‡æ¢ä¸€æ¬¡
        }
    }

    function stopQuoteCarousel() {
        const quoteContainer = document.getElementById('focusQuotes');
        quoteContainer.classList.add('hidden');
        if (quoteInterval) clearInterval(quoteInterval);
    }

    // ===========================
    // è®¡æ—¶å™¨é€»è¾‘ (ä¼˜åŒ–ç‰ˆï¼šæ”¯æŒæ­£è®¡æ—¶/å€’è®¡æ—¶)
    // ===========================
    let timerMode = 'up'; // 'up' or 'down'
    let countdownDuration = 25 * 60 * 1000; // default 25 mins

    function timeToString(time) {
      if (time < 0) time = 0;
      return new Date(time).toISOString().substr(11, 8);
    }

    function switchTimerMode(mode) {
        if (isStudying) return; // è®¡æ—¶ä¸­ä¸å¯åˆ‡æ¢
        timerMode = mode;
        
        const upBtn = document.getElementById('modeUpBtn');
        const downBtn = document.getElementById('modeDownBtn');
        const inputWrapper = document.getElementById('countdownInputWrapper');
        
        if (mode === 'up') {
            upBtn.className = 'px-6 py-2 rounded-full text-sm font-bold transition-all shadow-sm bg-white text-primary';
            downBtn.className = 'px-6 py-2 rounded-full text-sm font-bold transition-all text-gray-500 hover:bg-white/50';
            inputWrapper.classList.add('hidden');
            document.querySelector(".timer-display").innerHTML = "00:00:00";
        } else {
            downBtn.className = 'px-6 py-2 rounded-full text-sm font-bold transition-all shadow-sm bg-white text-primary';
            upBtn.className = 'px-6 py-2 rounded-full text-sm font-bold transition-all text-gray-500 hover:bg-white/50';
            inputWrapper.classList.remove('hidden');
            updateCountdownDisplay();
        }
    }

    function updateCountdownDisplay() {
        if (timerMode !== 'down' || isStudying) return;
        const mins = parseInt(document.getElementById('countdownMinutes').value) || 25;
        countdownDuration = mins * 60 * 1000;
        document.querySelector(".timer-display").innerHTML = timeToString(countdownDuration);
    }

    function tick() {
        const now = Date.now();
        const start = parseInt(localStorage.getItem('timer_start_timestamp') || now);
        const accumulated = parseInt(localStorage.getItem('timer_accumulated_before_start') || 0);
        
        if (timerMode === 'up') {
            elapsedTime = (now - start) + accumulated;
            document.querySelector(".timer-display").innerHTML = timeToString(elapsedTime);
        } else {
            // å€’è®¡æ—¶é€»è¾‘
            const totalDuration = parseInt(localStorage.getItem('timer_countdown_total_duration') || countdownDuration);
            // å·²ç»è¿‡å»çš„æ—¶é—´ = (å½“å‰ - å¼€å§‹) + ä¹‹å‰ç§¯ç´¯çš„
            const elapsedSinceStart = (now - start) + accumulated;
            const remaining = totalDuration - elapsedSinceStart;
            
            elapsedTime = elapsedSinceStart; // è®°å½•å·²ä¸“æ³¨æ—¶é—´ç”¨äºç»Ÿè®¡
            
            if (remaining <= 0) {
                // å€’è®¡æ—¶ç»“æŸ
                document.querySelector(".timer-display").innerHTML = "00:00:00";
                stopTimerWithRewardCheck(true); // true indicates auto-finish
            } else {
                document.querySelector(".timer-display").innerHTML = timeToString(remaining);
            }
        }
    }

    function setFocusMode(enable) {
        isStudying = enable;
        const body = document.body;
        const statusText = document.getElementById("timerStatus");
        const startBtn = document.getElementById("startBtn");
        const pauseBtn = document.getElementById("pauseBtn");
        const resetBtn = document.getElementById("resetBtn");
        const modeSwitcher = document.querySelector("#modeUpBtn").parentElement; // è·å–åˆ‡æ¢å™¨å®¹å™¨
        const inputWrapper = document.getElementById("countdownInputWrapper");

        if (enable) {
            body.classList.add("focus-mode");
            statusText.textContent = timerMode === 'up' ? "æ­£åœ¨å¿ƒæµæ¨¡å¼ä¸­ï¼Œä¿æŒä¸“æ³¨..." : "å€’è®¡æ—¶ä¸­ï¼Œå…¨ç¥è´¯æ³¨...";
            statusText.style.opacity = 1;
            startBtn.classList.add("hidden", "flex");
            startBtn.classList.remove("flex"); // ç¡®ä¿ç§»é™¤ flex
            startBtn.style.display = 'none'; // å¼ºåˆ¶éšè—
            
            pauseBtn.classList.remove("hidden");
            pauseBtn.classList.add("flex");
            resetBtn.classList.remove("hidden");
            resetBtn.classList.add("flex");
            
            // éšè—è®¾ç½®æ§ä»¶
            modeSwitcher.classList.add('opacity-0', 'pointer-events-none');
            inputWrapper.classList.add('opacity-0', 'pointer-events-none');
            
            startQuoteCarousel();
        } else {
            body.classList.remove("focus-mode");
            statusText.style.opacity = 0;
            startBtn.classList.remove("hidden");
            startBtn.style.display = ''; // æ¢å¤æ˜¾ç¤º
            
            pauseBtn.classList.add("hidden");
            pauseBtn.classList.remove("flex");
            resetBtn.classList.add("hidden");
            resetBtn.classList.remove("flex");
            
            // æ¢å¤è®¾ç½®æ§ä»¶
            modeSwitcher.classList.remove('opacity-0', 'pointer-events-none');
            inputWrapper.classList.remove('opacity-0', 'pointer-events-none');
            
            stopQuoteCarousel();
        }
    }

    function startTimer() {
        if (isStudying) return;
        
        // ä¿å­˜è‡ªå®šä¹‰é¼“åŠ±è¯­
        const customQuote = document.getElementById('customQuoteInput').value.trim();
        localStorage.setItem('timer_custom_quote', customQuote);

        // è®°å½•å¼€å§‹æ—¶é—´æˆ³åˆ°æœ¬åœ°å­˜å‚¨ï¼Œå®ç°åå°è®¡æ—¶
        const now = Date.now();
        localStorage.setItem('timer_start_timestamp', now);
        localStorage.setItem('timer_is_running', 'true');
        localStorage.setItem('timer_mode', timerMode);
        
        // æ— è®ºæ˜¯æ­£è®¡æ—¶è¿˜æ˜¯å€’è®¡æ—¶ï¼Œaccumulated éƒ½ä»£è¡¨â€œå·²ç»è¿‡å»çš„æ—¶é—´â€
        localStorage.setItem('timer_accumulated_before_start', elapsedTime);

        if (timerMode === 'down') {
            // å¦‚æœæ˜¯å€’è®¡æ—¶ï¼Œä¸”æ˜¯æ–°å¼€å§‹ï¼ˆelapsedTimeä¸º0ï¼‰ï¼Œä¿å­˜æ€»æ—¶é•¿
            // å¦‚æœæ˜¯ä»æš‚åœæ¢å¤ï¼ŒelapsedTime > 0ï¼Œä¸éœ€è¦é‡æ–°ä¿å­˜æ€»æ—¶é•¿ï¼Œæ²¿ç”¨æ—§çš„
            if (elapsedTime === 0 || !localStorage.getItem('timer_countdown_total_duration')) {
                 const mins = parseInt(document.getElementById('countdownMinutes').value) || 25;
                 countdownDuration = mins * 60 * 1000;
                 localStorage.setItem('timer_countdown_total_duration', countdownDuration);
            }
        }

        isStudying = true;
        tick(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
        timerInterval = setInterval(tick, 1000);
        setFocusMode(true);
    }

    function pauseTimer() {
        clearInterval(timerInterval);
        isStudying = false;
        
        // æ¢å¤è¾“å…¥æ¡†å†…å®¹
        const savedQuote = localStorage.getItem('timer_custom_quote');
        if (savedQuote) {
            document.getElementById('customQuoteInput').value = savedQuote;
        }

        // æ¸…é™¤è¿è¡ŒçŠ¶æ€ï¼Œä½†ä¿ç•™ elapsedTime
        localStorage.removeItem('timer_is_running');
        // æ­¤æ—¶ elapsedTime å·²ç»åœ¨ tick() ä¸­æ›´æ–°åˆ°äº†æœ€æ–°
        
        setFocusMode(false);
        document.getElementById("timerStatus").textContent = "å·²æš‚åœ";
        document.getElementById("timerStatus").style.opacity = 1;
    }

    // åœæ­¢è®¡æ—¶å¹¶æ£€æŸ¥æ˜¯å¦è§¦å‘å¥–åŠ±
    function stopTimerWithRewardCheck(autoFinish = false) {
        clearInterval(timerInterval);
        
        if (!autoFinish) tick(); // å¦‚æœä¸æ˜¯è‡ªåŠ¨ç»“æŸï¼Œæ›´æ–°æœ€åä¸€æ¬¡æ—¶é—´
        
        const finalTime = elapsedTime;
        
        // æ¸…ç†æ‰€æœ‰è®¡æ—¶å™¨ç›¸å…³çš„æœ¬åœ°å­˜å‚¨
        localStorage.removeItem('timer_start_timestamp');
        localStorage.removeItem('timer_accumulated_before_start');
        localStorage.removeItem('timer_is_running');
        localStorage.removeItem('timer_custom_quote'); // æ¸…é™¤è‡ªå®šä¹‰è¯­å½•
        localStorage.removeItem('timer_countdown_total_duration');
        localStorage.removeItem('timer_mode');
        
        document.getElementById('customQuoteInput').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†

        // è®¡ç®—ä¸“æ³¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰å’Œç§¯åˆ†
        const minutes = Math.floor(finalTime / 60000);
        if (minutes > 0) {
            appData.todayStudyTime += minutes;
            appData.points += minutes; // 1åˆ†é’Ÿ = 1ç§¯åˆ†
            saveData();
        }

        // é‡ç½®è®¡æ—¶å™¨çŠ¶æ€
        document.querySelector(".timer-display").innerHTML = "00:00:00";
        elapsedTime = 0;
        
        if (timerMode === 'down') {
             updateCountdownDisplay();
        }
        
        setFocusMode(false);

        // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°è·å¾—å¥–åŠ±çš„æ¡ä»¶
        if (autoFinish || finalTime > MIN_FOCUS_TIME_FOR_REWARD) {
            showRewardModal();
            if (autoFinish) {
                alert("ä¸“æ³¨ç›®æ ‡è¾¾æˆï¼ä¼‘æ¯ä¸€ä¸‹å§ ğŸ‰");
            }
        }
    }

    // é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬ï¼šå½“ç”¨æˆ·åˆ‡å›å¾®ä¿¡æ—¶ï¼Œç«‹å³åˆ·æ–°æ—¶é—´
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible' && isStudying) {
            tick();
        }
    });

    // é¡µé¢åŠ è½½æ—¶æ¢å¤è®¡æ—¶çŠ¶æ€ï¼ˆå¦‚æœæ„å¤–å…³é—­æˆ–åˆ·æ–°ï¼‰
    window.addEventListener('load', () => {
        if (localStorage.getItem('timer_is_running') === 'true') {
            isStudying = true;
            setFocusMode(true);
            tick();
            timerInterval = setInterval(tick, 1000);
        }
    });

    // ===========================
    // å¥–åŠ±ç›’å­é€»è¾‘ (æ”¹ç¼–è‡ªæƒ…ç»ªç›’å­)
    // ===========================
    const modal = document.getElementById('rewardModal');
    const modalContent = document.getElementById('modalContent');
    const cube = document.getElementById('rewardCube');
    const lid = document.getElementById('rewardLid');
    let isBoxOpen = false;

    function showRewardModal() {
        // 1. å‡†å¤‡éšæœºé¼“åŠ±è¯­
        const randomMsg = rewardMessages[Math.floor(Math.random() * rewardMessages.length)];
        document.getElementById('rewardIcon').textContent = randomMsg.icon;
        document.getElementById('rewardTitle').textContent = randomMsg.title;
        document.getElementById('rewardMessage').textContent = randomMsg.msg;

        // 2. æ˜¾ç¤ºå¼¹çª— (é‡ç½®ç›’å­çŠ¶æ€)
        cube.classList.remove('opened');
        lid.classList.remove('opened');
        isBoxOpen = false;

        modal.classList.remove('pointer-events-none', 'opacity-0');
        modalContent.classList.remove('scale-90');
        
        // 3. è‡ªåŠ¨æ‰“å¼€ç›’å­ (å»¶è¿Ÿä¸€ç‚¹ç‚¹å¢åŠ ä»ªå¼æ„Ÿ)
        setTimeout(() => {
            openRewardBox();
        }, 600);
    }

    function openRewardBox() {
        if (isBoxOpen) return;
        isBoxOpen = true;
        lid.classList.add('opened');
        cube.classList.add('opened');
    }

    function closeRewardModal() {
        modal.classList.add('opacity-0', 'pointer-events-none');
        modalContent.classList.add('scale-90');
        // å»¶è¿Ÿé‡ç½®ç›’å­çŠ¶æ€ï¼Œé¿å…å…³é—­æ—¶çœ‹åˆ°åŠ¨ç”»å›æ”¾
        setTimeout(() => {
            cube.classList.remove('opened');
            lid.classList.remove('opened');
            isBoxOpen = false;
        }, 500);
    }

    // ===========================
    // æ•°æ®æŒä¹…åŒ–ä¸çŠ¶æ€ç®¡ç†
    // ===========================
    const STORAGE_KEY = 'study_space_data';
    const defaultData = {
        points: 0, todayStudyTime: 0, lastStudyDate: new Date().toDateString(),
        dailyLogs: {}, todos: []
    };
    
    // åˆå¹¶é»˜è®¤æ•°æ®å’Œå­˜å‚¨æ•°æ®
    let appData = { ...defaultData, ...JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}') };
    
    // ç¡®ä¿å¼•ç”¨ç±»å‹å­—æ®µå­˜åœ¨ (é˜²æ­¢æ—§æ•°æ®è¦†ç›–é»˜è®¤å€¼å¯¼è‡´ undefined)
    appData.dailyLogs = appData.dailyLogs || {};
    appData.todos = appData.todos || [];

    // æ£€æŸ¥æ˜¯å¦è·¨å¤©ï¼Œé‡ç½®ä»Šæ—¥æ•°æ®
    if (appData.lastStudyDate !== new Date().toDateString()) {
        appData.todayStudyTime = 0;
        appData.lastStudyDate = new Date().toDateString();
        saveData();
    }

    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
        updateDashboard();
    }

    function updateDashboard() {
        document.getElementById('pointsDisplay').textContent = appData.points;
        document.getElementById('shopPointsDisplay').textContent = appData.points;
        document.getElementById('todayTimeDisplay').textContent = appData.todayStudyTime + 'm';
    }

    // ===========================
    // è®¡åˆ’æ¸…å•é€»è¾‘
    // ===========================
    // å®‰å…¨å·¥å…·ï¼šè½¬ä¹‰ HTML å­—ç¬¦ï¼Œé˜²æ­¢ XSS æ”»å‡»
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function renderTodos() {
        const list = document.getElementById('todoList');
        // æ£€æŸ¥æ˜¯å¦å¼€å¯äº†ç§¯é›ªç‰¹æ•ˆ (ç”± HolidayManager è®¾ç½®)
        const snowClass = window.isSnowEnabled ? 'snow-capped' : '';
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å·²å®Œæˆçš„ä»»åŠ¡ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºæ¸…ç†æŒ‰é’®ï¼ˆè¿™é‡Œå¯ä»¥æ‰©å±• UIï¼Œæš‚æ—¶ä¿æŒç®€æ´ï¼‰
        
        list.innerHTML = appData.todos.map(todo => `
            <li class="todo-item flex items-center gap-3 p-3 bg-white/60 rounded-xl border border-gray-100 shadow-sm transition-all hover:shadow-md group ${todo.completed ? 'opacity-60' : ''} ${snowClass}">
                <button onclick="toggleTodo(${todo.id})" class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors relative z-30 ${todo.completed ? 'bg-primary border-primary text-white' : 'border-gray-300 hover:border-primary'}">
                    ${todo.completed ? '<i class="fa fa-check text-xs"></i>' : ''}
                </button>
                <span class="flex-1 font-medium ${todo.completed ? 'line-through text-gray-400' : 'text-gray-700'} relative z-30">${escapeHtml(todo.text)}</span>
                <button type="button" onclick="removeTodoItem('${todo.id}')" class="text-gray-400 hover:text-red-500 transition-colors px-2 p-2 rounded-lg hover:bg-red-50 relative z-50 cursor-pointer">
                    <i class="fa fa-trash pointer-events-none"></i>
                </button>
            </li>
        `).join('');
    }

    function addTodo(event) {
        if (event) event.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤
        const input = document.getElementById('todoInput');
        const text = input.value.trim();
        
        if (text) {
            appData.todos.unshift({
                id: Date.now(),
                text: text,
                completed: false
            });
            saveData();
            renderTodos();
            input.value = '';
        }
    }

    function toggleTodo(id) {
        const todo = appData.todos.find(t => t.id === id);
        if (todo) {
            todo.completed = !todo.completed;
            // å®Œæˆä»»åŠ¡å¥–åŠ±ç§¯åˆ†
            if (todo.completed) {
                appData.points += 10;
                alert('ä»»åŠ¡å®Œæˆï¼ç§¯åˆ† +10 ğŸ‰');
            } else {
                appData.points -= 10; // å–æ¶ˆå®Œæˆæ‰£å›ç§¯åˆ†
            }
            saveData();
            renderTodos();
        }
    }

    function removeTodoItem(id) {
        // ç»Ÿä¸€ä½¿ç”¨ window.event å¤„ç†å†’æ³¡ï¼Œä¸ redeemItem ä¿æŒä¸€è‡´
        if (window.event) {
            window.event.stopPropagation();
        }
        
        // å»¶æ—¶å¤„ç†ï¼Œç¡®ä¿ UI å“åº”
        setTimeout(() => {
            if(confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                // ç»Ÿä¸€è½¬æ¢ä¸ºå­—ç¬¦ä¸²æ¯”è¾ƒï¼Œç®€åŒ–é€»è¾‘ï¼ŒåŒæ—¶å…¼å®¹æ•°å­—å’Œå­—ç¬¦ä¸²ID
                appData.todos = appData.todos.filter(t => String(t.id) !== String(id));
                saveData();
                renderTodos();
            }
        }, 10);
    }

    // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
    document.getElementById('todoForm').addEventListener('submit', addTodo);

    // åˆå§‹åŒ–æ˜¾ç¤º
    updateDashboard();
    // renderTodos(); // ç§»åˆ° HolidayManager ä¹‹åè°ƒç”¨ï¼Œç¡®ä¿ç§¯é›ªæ•ˆæœæ­£ç¡®åº”ç”¨

    // ===========================
    // ç§¯åˆ†å•†åŸé€»è¾‘
    // ===========================
    const shopItems = [
        { id: 1, name: 'ä¸€æ¯å¥¶èŒ¶ ğŸ§‹', cost: 800, icon: 'ğŸ§‹' },
        { id: 2, name: 'ä¸€åŒ…è–¯ç‰‡ ğŸ¥”', cost: 500, icon: 'ğŸ¥”' },
        { id: 3, name: 'ä¸€é¡¿å¤§é¤ ğŸ²', cost: 2500, icon: 'ğŸ²' },
        { id: 4, name: 'çœ‹åœºç”µå½± ğŸ¬', cost: 1500, icon: 'ğŸ¬' },
        { id: 5, name: 'ç¡ä¸ªæ‡’è§‰ ğŸ›Œ', cost: 1000, icon: 'ï¿½' },
    ];

    function openShop() {
        const modal = document.getElementById('shopModal');
        const content = document.getElementById('shopContent');
        modal.classList.remove('pointer-events-none', 'opacity-0');
        content.classList.remove('scale-95');
        renderShopItems();
    }

    function closeShop() {
        const modal = document.getElementById('shopModal');
        const content = document.getElementById('shopContent');
        modal.classList.add('pointer-events-none', 'opacity-0');
        content.classList.add('scale-95');
    }

    function renderShopItems() {
        const container = document.getElementById('shopItems');
        // å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å­—ï¼Œç¡®ä¿æ¯”è¾ƒé€»è¾‘æ­£ç¡®
        const currentPoints = Number(appData.points) || 0;
        
        container.innerHTML = shopItems.map(item => {
            const canAfford = currentPoints >= item.cost;
            // åŠ¨æ€ç”Ÿæˆæ ·å¼å’Œç‚¹å‡»äº‹ä»¶
            const btnClass = canAfford 
                ? 'bg-primary text-white hover:bg-primary-dark shadow-md hover:shadow-lg active:scale-95 cursor-pointer' 
                : 'bg-gray-100 text-gray-400 cursor-not-allowed';
            
            // ç®€åŒ–ç‚¹å‡»äº‹ä»¶ï¼Œç§»é™¤ event å‚æ•°ä¼ é€’ï¼Œæ”¹ç”¨ window.event
            const clickAction = canAfford ? `redeemItem(${item.id})` : "alert('ç§¯åˆ†ä¸è¶³ï¼Œç»§ç»­åŠ æ²¹ä¸“æ³¨å§ï¼ğŸ’ª')";

            return `
            <div class="bg-white border border-gray-100 rounded-xl p-4 flex flex-col items-center hover:shadow-md transition-all group relative">
                <div class="text-4xl mb-2 group-hover:scale-110 transition-transform">${item.icon}</div>
                <h3 class="font-bold text-gray-800 mb-1">${item.name}</h3>
                <div class="text-secondary font-bold mb-3">${item.cost} ç§¯åˆ†</div>
                <button type="button" onclick="${clickAction}" class="w-full py-2 rounded-lg text-sm font-bold transition-all duration-200 relative z-50 ${btnClass}">
                    <span class="pointer-events-none">å…‘æ¢</span>
                </button>
            </div>
        `}).join('');
    }

    function redeemItem(id) {
        // å°è¯•é˜»æ­¢å†’æ³¡ï¼Œé˜²æ­¢è¯¯è§¦
        if (window.event) {
            window.event.stopPropagation();
        }

        const item = shopItems.find(i => i.id === id);
        if (!item) {
            alert('å•†å“æ•°æ®å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }

        const currentPoints = Number(appData.points) || 0;
        
        if (currentPoints >= item.cost) {
            // å»¶æ—¶ä¸€ç‚¹ç‚¹å¼¹å‡º confirmï¼Œé˜²æ­¢ç‚¹å‡»äº‹ä»¶å†²çª
            setTimeout(() => {
                if(confirm(`ç¡®å®šè¦æ¶ˆè€— ${item.cost} ç§¯åˆ†å…‘æ¢ "${item.name}" å—ï¼Ÿ`)) {
                    appData.points = currentPoints - item.cost;
                    saveData();
                    updateDashboard(); // ç«‹å³æ›´æ–°é¡¶éƒ¨ç§¯åˆ†æ˜¾ç¤º
                    renderShopItems(); // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    alert(`å…‘æ¢æˆåŠŸï¼å¿«å»äº«å—ä½ çš„ ${item.name} å§ï¼ğŸ‰`);
                }
            }, 10);
        } else {
            alert('ç§¯åˆ†ä¸è¶³ï¼Œç»§ç»­åŠ æ²¹ä¸“æ³¨å§ï¼ğŸ’ª');
        }
    }

    // ===========================
    // æˆé•¿æ—¥å†é€»è¾‘
    // ===========================
    // è¾…åŠ©å‡½æ•°ï¼šè·å–æœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸² YYYY-MM-DD
    function getLocalDateString(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    let currentCalendarDate = new Date();
    let selectedDateStr = getLocalDateString(new Date());

    function openCalendar() {
        const modal = document.getElementById('calendarModal');
        const content = document.getElementById('calendarContent');
        modal.classList.remove('pointer-events-none', 'opacity-0');
        content.classList.remove('scale-95');
        renderCalendar();
        loadDailyLog(selectedDateStr);
    }

    function closeCalendar() {
        const modal = document.getElementById('calendarModal');
        const content = document.getElementById('calendarContent');
        modal.classList.add('pointer-events-none', 'opacity-0');
        content.classList.add('scale-95');
    }

    function changeMonth(offset) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
        renderCalendar();
    }

    function renderCalendar() {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        
        document.getElementById('calendarMonthYear').textContent = `${year}å¹´ ${month + 1}æœˆ`;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay(); // 0 is Sunday
        
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        // Empty slots for days before start of month
        for (let i = 0; i < startingDay; i++) {
            grid.innerHTML += `<div></div>`;
        }

        // Days
        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const hasLog = appData.dailyLogs[dateStr];
            const isSelected = dateStr === selectedDateStr;
            const isToday = dateStr === getLocalDateString(new Date());
            
            let bgClass = 'hover:bg-gray-50 bg-white';
            if (isSelected) bgClass = 'bg-primary text-white hover:bg-primary';
            else if (isToday) bgClass = 'border-2 border-primary text-primary font-bold';
            
            // Mood indicator dot
            let moodDot = '';
            if (hasLog && hasLog.mood) {
                const moodColors = { happy: 'bg-yellow-400', calm: 'bg-green-400', tired: 'bg-blue-400', sad: 'bg-gray-400', fire: 'bg-red-500' };
                moodDot = `<div class="absolute bottom-1 right-1 w-1.5 h-1.5 rounded-full ${moodColors[hasLog.mood] || 'bg-gray-300'}"></div>`;
            }

            grid.innerHTML += `
                <div onclick="selectDate('${dateStr}')" class="relative h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-xl cursor-pointer transition-all text-sm ${bgClass}">
                    ${day}
                    ${moodDot}
                </div>
            `;
        }
    }

    function selectDate(dateStr) {
        selectedDateStr = dateStr;
        renderCalendar(); // Re-render to update selection style
        loadDailyLog(dateStr);
    }

    let currentMood = null;

    function loadDailyLog(dateStr) {
        document.getElementById('selectedDateDisplay').textContent = dateStr;
        // ç¡®ä¿ dailyLogs å­˜åœ¨
        if (!appData.dailyLogs) appData.dailyLogs = {};
        
        const log = appData.dailyLogs[dateStr] || { mood: null, note: '' };
        
        // Reset mood buttons
        document.querySelectorAll('.mood-btn').forEach(btn => {
            btn.classList.remove('bg-gray-200', 'scale-110', 'ring-2', 'ring-primary', 'bg-primary/10');
        });
        
        // Set mood if exists
        if (log.mood) {
            const btn = document.querySelector(`.mood-btn[data-mood="${log.mood}"]`);
            if (btn) btn.classList.add('scale-110', 'ring-2', 'ring-primary', 'bg-primary/10');
        }
        currentMood = log.mood;

        // Set note
        document.getElementById('dailyNote').value = log.note;
    }

    function selectMood(mood) {
        currentMood = mood;
        document.querySelectorAll('.mood-btn').forEach(btn => {
            btn.classList.remove('scale-110', 'ring-2', 'ring-primary', 'bg-primary/10');
        });
        const btn = document.querySelector(`.mood-btn[data-mood="${mood}"]`);
        if (btn) btn.classList.add('scale-110', 'ring-2', 'ring-primary', 'bg-primary/10');
    }

    function saveDailyLog() {
        // é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿ dailyLogs å¯¹è±¡å­˜åœ¨
        if (!appData.dailyLogs) {
            appData.dailyLogs = {};
        }

        const note = document.getElementById('dailyNote').value;
        
        // å¦‚æœæ²¡æœ‰é€‰æ‹©å¿ƒæƒ…ä¸”æ²¡æœ‰å†™æ—¥è®°ï¼Œæç¤ºç”¨æˆ·
        if (!currentMood && !note.trim()) {
            alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¿ƒæƒ…æˆ–å†™ç‚¹ä»€ä¹ˆå§~ ğŸ¤”');
            return;
        }

        appData.dailyLogs[selectedDateStr] = {
            mood: currentMood,
            note: note
        };
        saveData();
        renderCalendar(); // Update dots
        alert('è®°å½•å·²ä¿å­˜ ğŸ“');
    }

    // ===========================
    // èŠ‚æ—¥æ°›å›´é€»è¾‘
    // ===========================
    const HolidayManager = {
        check: function() {
            const date = new Date();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            // åœ£è¯èŠ‚ (12.24 - 12.25)
            if (month === 12 && (day === 24 || day === 25)) {
                this.applyTheme({
                    name: 'Christmas',
                    // ä½¿ç”¨æ–‡æœ¬å­—ç¬¦è€Œé Emojiï¼Œä»¥ä¾¿ CSS é¢œè‰²ç”Ÿæ•ˆ
                    particles: ['â…', 'â†', 'â€¢'], 
                    particleClass: 'snow', // æŒ‡å®šé›ªèŠ±æ ·å¼ç±»
                    decoration: 'ğŸ„', // å³ä¸‹è§’
                    decorationLeft: 'ğŸ…', // å·¦ä¸‹è§’
                    garland: ['ğŸ„', 'âœ¨', 'ğŸ', 'âœ¨', 'ğŸ””', 'âœ¨', 'ğŸ¦Œ', 'âœ¨'], // é¡¶éƒ¨æŒ‚é¥°åºåˆ—
                    message: 'Merry Christmas! ğŸ„ğŸ…',
                    snowCapped: true // å¼€å¯ç§¯é›ªæ•ˆæœ
                });
            }
            // å…ƒæ—¦ (1.1)
            else if (month === 1 && day === 1) {
                this.applyTheme({
                    name: 'NewYear',
                    particles: ['ğŸ‰', 'âœ¨', 'ğŸ§§', 'ğŸ®'],
                    decoration: 'ğŸ†',
                    decorationLeft: 'ğŸ²',
                    garland: ['ğŸ§§', 'ğŸ§¨', 'ğŸ®', 'ğŸ§¨', 'ğŸ§§', '2026', 'ğŸ§§'],
                    message: 'Happy New Year! ğŸ‰'
                });
            }
            // æƒ…äººèŠ‚ (2.14)
            else if (month === 2 && day === 14) {
                this.applyTheme({
                    name: 'Valentine',
                    particles: ['â¤ï¸', 'ï¿½', 'ï¿½', 'ğŸ’Œ'],
                    decoration: 'ğŸ§¸',
                    decorationLeft: 'ğŸ’˜',
                    garland: ['â¤ï¸', 'ğŸŒ¹', 'ğŸ’–', 'ğŸŒ¹', 'â¤ï¸'],
                    message: 'Happy Valentine\'s Day! ğŸ’–'
                });
            }
            // ä¸‡åœ£èŠ‚ (10.31)
            else if (month === 10 && day === 31) {
                this.applyTheme({
                    name: 'Halloween',
                    particles: ['ğŸ¦‡', 'ğŸƒ', 'ğŸ‘»', 'ğŸ•¸ï¸'],
                    decoration: 'ğŸ•¸ï¸',
                    decorationLeft: 'ğŸ§Ÿ',
                    garland: ['ğŸƒ', 'ğŸ‘»', 'ğŸ¦‡', 'ğŸ‘»', 'ğŸƒ'],
                    message: 'Trick or Treat! ğŸƒ'
                });
            }
        },

        applyTheme: function(theme) {
            // 1. æ·»åŠ å³ä¸‹è§’è£…é¥°
            if (theme.decoration) {
                const decoration = document.createElement('div');
                decoration.className = 'holiday-decoration hidden sm:block';
                decoration.textContent = theme.decoration;
                decoration.title = theme.message;
                decoration.onclick = () => alert(theme.message);
                document.body.appendChild(decoration);
            }

            // 2. æ·»åŠ å·¦ä¸‹è§’è£…é¥°
            if (theme.decorationLeft) {
                const decorationLeft = document.createElement('div');
                decorationLeft.className = 'holiday-decoration-left hidden sm:block';
                decorationLeft.textContent = theme.decorationLeft;
                decorationLeft.title = theme.message;
                document.body.appendChild(decorationLeft);
            }

            // 3. æ·»åŠ é¡¶éƒ¨æŒ‚é¥° (Garland)
            if (theme.garland && theme.garland.length > 0) {
                const garlandContainer = document.createElement('div');
                garlandContainer.className = 'holiday-garland';
                // é‡å¤å¡«å……ç›´åˆ°å¡«æ»¡å±å¹•å®½åº¦å¤§æ¦‚æ•°é‡
                const repeatCount = 20; 
                for (let i = 0; i < repeatCount; i++) {
                    const item = theme.garland[i % theme.garland.length];
                    const span = document.createElement('span');
                    span.textContent = item;
                    garlandContainer.appendChild(span);
                }
                document.body.appendChild(garlandContainer);
            }

            // 4. ä¿®æ”¹æ ‡é¢˜ (å¯é€‰)
            const title = document.querySelector('h1');
            if (title) {
                title.innerHTML = `${theme.particles[0]} ${title.innerText} ${theme.particles[0]}`;
            }

            // 5. ç§¯é›ªæ•ˆæœ (å¦‚æœå¼€å¯)
            if (theme.snowCapped) {
                window.isSnowEnabled = true; // è®¾ç½®å…¨å±€æ ‡å¿—ï¼Œä¾› renderTodos ä½¿ç”¨
                // ç»™ä¸»è¦å¡ç‰‡å’ŒæŒ‰é’®æ·»åŠ ç§¯é›ª
                // æ³¨æ„ï¼šéœ€è¦ç¡®ä¿è¿™äº›å…ƒç´ æœ‰ relative å®šä½ï¼Œæˆ–è€… snow-capped ç±»å·²ç»å¤„ç†äº†
                const elementsToCap = document.querySelectorAll('#startBtn, .bg-white, .bg-white\\/90, .bg-white\\/80, .bg-white\\/60, .bg-white\\/50');
                elementsToCap.forEach(el => {
                    // æ’é™¤ä¸€äº›ä¸é€‚åˆç§¯é›ªçš„å°å…ƒç´ æˆ–ç‰¹å®šå®¹å™¨
                    if (!el.classList.contains('no-snow')) {
                        el.classList.add('snow-capped');
                    }
                });
            }

            // 6. å¯åŠ¨ç²’å­æ•ˆæœ
            this.startParticles(theme.particles, theme.particleClass);
        },

        startParticles: function(chars, extraClass) {
            // é™åˆ¶æœ€å¤§ç²’å­æ•°
            const MAX_PARTICLES = 150; // å¢åŠ æ•°é‡åˆ° 150
            let particleCount = 0;

            setInterval(() => {
                if (document.hidden) return;
                if (particleCount >= MAX_PARTICLES) return; 
                
                const p = document.createElement('div');
                p.textContent = chars[Math.floor(Math.random() * chars.length)];
                p.className = 'holiday-particle ' + (extraClass || '');
                
                // éšæœºä½ç½®å’Œå±æ€§
                p.style.left = Math.random() * 100 + 'vw';
                // å¢å¤§ç²’å­å°ºå¯¸èŒƒå›´
                p.style.fontSize = (Math.random() * 35 + 15) + 'px';
                const duration = Math.random() * 3 + 4; // 4-7s
                p.style.animationDuration = duration + 's';
                p.style.opacity = Math.random() * 0.7 + 0.5; // æ›´ä¸é€æ˜
                
                document.body.appendChild(p);
                particleCount++;

                // åŠ¨ç”»ç»“æŸåç§»é™¤
                setTimeout(() => {
                    p.remove();
                    particleCount--;
                }, duration * 1000);
            }, 80); // é¢‘ç‡åŠ å¿«åˆ° 80ms
        }
    };


    // åˆå§‹åŒ–è°ƒç”¨
    HolidayManager.check();
    renderTodos(); // ç¡®ä¿åœ¨ä¸»é¢˜åº”ç”¨åæ¸²æŸ“åˆ—è¡¨
  </script>

  <style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(16, 185, 129, 0.2); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(16, 185, 129, 0.4); }
    /* ç®€å•çš„æ·¡å…¥åŠ¨ç”»é…ç½® */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    /* æ–‡å­—é˜´å½±å·¥å…·ç±» */
    .text-shadow-lg { text-shadow: 0 4px 8px rgba(0,0,0,0.3); }
  </style>
</body>
</html>